{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/lib/db.ts"],"sourcesContent":["// Database connection pool for PostgreSQL\r\nimport { Pool, PoolClient, QueryResult } from 'pg';\r\n\r\nif (!process.env.DATABASE_URL) {\r\n  console.warn('⚠️  WARNING: DATABASE_URL not set. Database operations will fail.');\r\n}\r\n\r\nconst pool = new Pool({\r\n  connectionString: process.env.DATABASE_URL,\r\n  max: 20,\r\n  // Increase timeouts to be more tolerant of transient network/DB latency\r\n  idleTimeoutMillis: 60000,\r\n  connectionTimeoutMillis: 10000,\r\n});\r\n\r\n// Test connection\r\npool.on('connect', () => {\r\n  console.log('✅ Database connected');\r\n});\r\n\r\npool.on('error', (err) => {\r\n  console.error('❌ Unexpected database error:', err);\r\n  // Don't exit process in production, just log the error\r\n  if (process.env.NODE_ENV !== 'production') {\r\n    process.exit(-1);\r\n  }\r\n});\r\n\r\nexport default pool;\r\n\r\n// Export query function\r\nexport const query = pool.query.bind(pool);\r\n\r\n// Safe query with retry for transient connection issues\r\nexport async function safeQuery(text: string, params?: any[]): Promise<QueryResult<any>> {\r\n  const maxAttempts = 3;\r\n  for (let attempt = 1; attempt <= maxAttempts; attempt++) {\r\n    try {\r\n      return await pool.query(text, params);\r\n    } catch (err: any) {\r\n      const msg = err?.message || '';\r\n      const isTransient = msg.includes('Connection terminated') || msg.includes('connection timeout') || msg.includes('Connection terminated unexpectedly') || msg.includes('ECONNRESET') || err?.code === '57P01' || err?.code === 'ECONNRESET' || err?.code === '57P03';\r\n      if (attempt < maxAttempts && isTransient) {\r\n        console.warn(`⚠️ Transient DB error (attempt ${attempt}): ${msg}. Retrying in ${attempt * 300}ms...`);\r\n        await new Promise((resolve) => setTimeout(resolve, attempt * 300));\r\n        continue;\r\n      }\r\n      throw err;\r\n    }\r\n  }\r\n  throw new Error('safeQuery: exhausted retries without success');\r\n}\r\n\r\n// Helper function for transactions\r\nexport async function withTransaction<T>(\r\n  callback: (client: PoolClient) => Promise<T>\r\n): Promise<T> {\r\n  const client = await pool.connect();\r\n  try {\r\n    await client.query('BEGIN');\r\n    const result = await callback(client);\r\n    await client.query('COMMIT');\r\n    return result;\r\n  } catch (error) {\r\n    await client.query('ROLLBACK');\r\n    throw error;\r\n  } finally {\r\n    client.release();\r\n  }\r\n}\r\n\r\n// Common database queries\r\nexport const db = {\r\n  // Users\r\n  async getUserByEmail(email: string) {\r\n    const result = await pool.query(\r\n      'SELECT * FROM users WHERE email = $1',\r\n      [email]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async getUserById(id: string) {\r\n    const result = await pool.query(\r\n      'SELECT id, email, name, created_at FROM users WHERE id = $1',\r\n      [id]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async createUser(email: string, name: string, passwordHash: string) {\r\n    const result = await pool.query(\r\n      'INSERT INTO users (email, name, password_hash) VALUES ($1, $2, $3) RETURNING id, email, name, created_at',\r\n      [email, name, passwordHash]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async updateUserPassword(userId: string, passwordHash: string) {\r\n    await pool.query(\r\n      'UPDATE users SET password_hash = $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2',\r\n      [passwordHash, userId]\r\n    );\r\n  },\r\n\r\n  async updateLastLogin(userId: string) {\r\n    await pool.query(\r\n      'UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = $1',\r\n      [userId]\r\n    );\r\n  },\r\n\r\n  // Verification tokens\r\n  async createVerificationToken(userId: string, token: string, expiresAt: Date) {\r\n    await pool.query(\r\n      'INSERT INTO verification_tokens (user_id, token, expires_at) VALUES ($1, $2, $3)',\r\n      [userId, token, expiresAt]\r\n    );\r\n  },\r\n\r\n  async getVerificationToken(token: string) {\r\n    const result = await pool.query(\r\n      'SELECT * FROM verification_tokens WHERE token = $1 AND expires_at > NOW()',\r\n      [token]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async deleteVerificationToken(token: string) {\r\n    await pool.query('DELETE FROM verification_tokens WHERE token = $1', [token]);\r\n  },\r\n\r\n  // Transactions\r\n  async getTransactions(userId: string, limit = 50, offset = 0) {\r\n    const result = await pool.query(\r\n      `SELECT t.*, c.name as category_name, a.name as account_name \r\n       FROM transactions t\r\n       LEFT JOIN categories c ON t.category_id = c.id\r\n       LEFT JOIN accounts a ON t.account_id = a.id\r\n       WHERE t.user_id = $1\r\n       ORDER BY t.date DESC, t.created_at DESC\r\n       LIMIT $2 OFFSET $3`,\r\n      [userId, limit, offset]\r\n    );\r\n    return result.rows;\r\n  },\r\n\r\n  async createTransaction(userId: string, data: {\r\n    accountId?: string;\r\n    categoryId?: string;\r\n    type: string;\r\n    amount: number;\r\n    description?: string;\r\n    date: Date;\r\n    notes?: string;\r\n  }) {\r\n    const result = await pool.query(\r\n      `INSERT INTO transactions (user_id, account_id, category_id, type, amount, description, date, notes)\r\n       VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\r\n       RETURNING *`,\r\n      [userId, data.accountId, data.categoryId, data.type, data.amount, data.description, data.date, data.notes]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n};\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 222, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/lib/settings.ts"],"sourcesContent":["import pool, { safeQuery } from './db';\r\n\r\nexport type UserSettings = {\r\n  user_id: string;\r\n  theme_mode: 'light' | 'dark' | 'system';\r\n  default_currency: string;\r\n  date_format: string;\r\n  number_format: 'standard' | 'compact';\r\n  notifications_enabled: boolean;\r\n  chart_palette?: {\r\n    categorical?: string[];\r\n    income?: string;\r\n    expense?: string;\r\n  } | null;\r\n  created_at?: string;\r\n  updated_at?: string;\r\n};\r\n\r\nexport async function getUserSettings(userId: string): Promise<UserSettings> {\r\n  const result = await safeQuery('SELECT * FROM user_settings WHERE user_id = $1', [userId]);\r\n  if (result.rows[0]) {\r\n    return result.rows[0];\r\n  }\r\n  // Create default settings row if missing\r\n  const insert = await safeQuery(\r\n    `INSERT INTO user_settings (user_id) VALUES ($1)\r\n     RETURNING *`,\r\n    [userId]\r\n  );\r\n  return insert.rows[0];\r\n}\r\n\r\nexport async function updateUserSettings(userId: string, partial: Partial<UserSettings>): Promise<UserSettings> {\r\n  // Build dynamic update\r\n  const fields: string[] = [];\r\n  const values: any[] = [];\r\n  let idx = 1;\r\n  for (const [key, value] of Object.entries(partial)) {\r\n    if (value === undefined) continue;\r\n    fields.push(`${key} = $${idx}`);\r\n    values.push(key === 'chart_palette' ? JSON.stringify(value) : value);\r\n    idx++;\r\n  }\r\n  if (!fields.length) {\r\n    const current = await getUserSettings(userId);\r\n    return current;\r\n  }\r\n  values.push(userId);\r\n  const sql = `UPDATE user_settings SET ${fields.join(', ')}, updated_at = CURRENT_TIMESTAMP WHERE user_id = $${idx} RETURNING *`;\r\n  const result = await safeQuery(sql, values);\r\n  return result.rows[0];\r\n}\r\n\r\n// Account update helpers (rename, deactivate, change currency)\r\nexport async function renameAccount(userId: string, accountId: string, name: string) {\r\n  await safeQuery(\r\n    'UPDATE accounts SET name = $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2 AND user_id = $3',\r\n    [name, accountId, userId]\r\n  );\r\n}\r\n\r\nexport async function setAccountActive(userId: string, accountId: string, isActive: boolean) {\r\n  await safeQuery(\r\n    'UPDATE accounts SET is_active = $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2 AND user_id = $3',\r\n    [isActive, accountId, userId]\r\n  );\r\n}\r\n\r\nexport async function changeAccountCurrency(userId: string, accountId: string, currency: string) {\r\n  await safeQuery(\r\n    'UPDATE accounts SET currency = $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2 AND user_id = $3',\r\n    [currency, accountId, userId]\r\n  );\r\n}\r\n\r\nexport const settings = {\r\n  getUserSettings,\r\n  updateUserSettings,\r\n  renameAccount,\r\n  setAccountActive,\r\n  changeAccountCurrency,\r\n};\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;;;;;AAkBO,eAAe,gBAAgB,MAAc;IAClD,MAAM,SAAS,MAAM,IAAA,wHAAS,EAAC,kDAAkD;QAAC;KAAO;IACzF,IAAI,OAAO,IAAI,CAAC,EAAE,EAAE;QAClB,OAAO,OAAO,IAAI,CAAC,EAAE;IACvB;IACA,yCAAyC;IACzC,MAAM,SAAS,MAAM,IAAA,wHAAS,EAC5B,CAAC;gBACW,CAAC,EACb;QAAC;KAAO;IAEV,OAAO,OAAO,IAAI,CAAC,EAAE;AACvB;AAEO,eAAe,mBAAmB,MAAc,EAAE,OAA8B;IACrF,uBAAuB;IACvB,MAAM,SAAmB,EAAE;IAC3B,MAAM,SAAgB,EAAE;IACxB,IAAI,MAAM;IACV,KAAK,MAAM,CAAC,KAAK,MAAM,IAAI,OAAO,OAAO,CAAC,SAAU;QAClD,IAAI,UAAU,WAAW;QACzB,OAAO,IAAI,CAAC,GAAG,IAAI,IAAI,EAAE,KAAK;QAC9B,OAAO,IAAI,CAAC,QAAQ,kBAAkB,KAAK,SAAS,CAAC,SAAS;QAC9D;IACF;IACA,IAAI,CAAC,OAAO,MAAM,EAAE;QAClB,MAAM,UAAU,MAAM,gBAAgB;QACtC,OAAO;IACT;IACA,OAAO,IAAI,CAAC;IACZ,MAAM,MAAM,CAAC,yBAAyB,EAAE,OAAO,IAAI,CAAC,MAAM,kDAAkD,EAAE,IAAI,YAAY,CAAC;IAC/H,MAAM,SAAS,MAAM,IAAA,wHAAS,EAAC,KAAK;IACpC,OAAO,OAAO,IAAI,CAAC,EAAE;AACvB;AAGO,eAAe,cAAc,MAAc,EAAE,SAAiB,EAAE,IAAY;IACjF,MAAM,IAAA,wHAAS,EACb,gGACA;QAAC;QAAM;QAAW;KAAO;AAE7B;AAEO,eAAe,iBAAiB,MAAc,EAAE,SAAiB,EAAE,QAAiB;IACzF,MAAM,IAAA,wHAAS,EACb,qGACA;QAAC;QAAU;QAAW;KAAO;AAEjC;AAEO,eAAe,sBAAsB,MAAc,EAAE,SAAiB,EAAE,QAAgB;IAC7F,MAAM,IAAA,wHAAS,EACb,oGACA;QAAC;QAAU;QAAW;KAAO;AAEjC;AAEO,MAAM,WAAW;IACtB;IACA;IACA;IACA;IACA;AACF","debugId":null}},
    {"offset": {"line": 311, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/app/api/settings/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { getUserSettings, updateUserSettings } from '@/lib/settings';\r\n\r\n// TODO: Replace with real auth extraction when available\r\nasync function getUserId(req: NextRequest): Promise<string | null> {\r\n  // If you have /api/auth/me cookie session, call it or read from headers\r\n  const userHeader = req.headers.get('x-user-id');\r\n  return userHeader; // temporary dev hook; frontend should set this after login if needed\r\n}\r\n\r\nexport async function GET(req: NextRequest) {\r\n  try {\r\n    const userId = await getUserId(req);\r\n    if (!userId) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    const settings = await getUserSettings(userId);\r\n    return NextResponse.json({ success: true, settings });\r\n  } catch (e: any) {\r\n    return NextResponse.json({ success: false, error: e?.message || 'Failed to fetch settings' }, { status: 500 });\r\n  }\r\n}\r\n\r\nexport async function PUT(req: NextRequest) {\r\n  try {\r\n    const userId = await getUserId(req);\r\n    if (!userId) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    const body = await req.json();\r\n    const updated = await updateUserSettings(userId, body);\r\n    return NextResponse.json({ success: true, settings: updated });\r\n  } catch (e: any) {\r\n    return NextResponse.json({ success: false, error: e?.message || 'Failed to update settings' }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;;;;;AAEA,yDAAyD;AACzD,eAAe,UAAU,GAAgB;IACvC,wEAAwE;IACxE,MAAM,aAAa,IAAI,OAAO,CAAC,GAAG,CAAC;IACnC,OAAO,YAAY,qEAAqE;AAC1F;AAEO,eAAe,IAAI,GAAgB;IACxC,IAAI;QACF,MAAM,SAAS,MAAM,UAAU;QAC/B,IAAI,CAAC,QAAQ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;QAC/E,MAAM,WAAW,MAAM,IAAA,oIAAe,EAAC;QACvC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM;QAAS;IACrD,EAAE,OAAO,GAAQ;QACf,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO,GAAG,WAAW;QAA2B,GAAG;YAAE,QAAQ;QAAI;IAC9G;AACF;AAEO,eAAe,IAAI,GAAgB;IACxC,IAAI;QACF,MAAM,SAAS,MAAM,UAAU;QAC/B,IAAI,CAAC,QAAQ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;QAC/E,MAAM,OAAO,MAAM,IAAI,IAAI;QAC3B,MAAM,UAAU,MAAM,IAAA,uIAAkB,EAAC,QAAQ;QACjD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,UAAU;QAAQ;IAC9D,EAAE,OAAO,GAAQ;QACf,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO,GAAG,WAAW;QAA4B,GAAG;YAAE,QAAQ;QAAI;IAC/G;AACF","debugId":null}}]
}