{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/lib/db.ts"],"sourcesContent":["// Database connection pool for PostgreSQL\r\nimport { Pool, PoolClient, QueryResult } from 'pg';\r\n\r\n// Support discrete DB_* env vars or a full DATABASE_URL\r\nfunction buildConnectionString(): string | undefined {\r\n  if (process.env.DATABASE_URL) return process.env.DATABASE_URL;\r\n  const host = process.env.DB_HOST;\r\n  const user = process.env.DB_USER;\r\n  const pass = process.env.DB_PASSWORD;\r\n  const name = process.env.DB_NAME;\r\n  const port = process.env.DB_PORT || '5432';\r\n  if (host && user && pass && name) {\r\n    return `postgresql://${user}:${encodeURIComponent(pass)}@${host}:${port}/${name}`;\r\n  }\r\n  return undefined;\r\n}\r\n\r\nconst connectionString = buildConnectionString();\r\nif (!connectionString) {\r\n  console.warn('‚ö†Ô∏è  WARNING: No database connection details provided. Set DATABASE_URL or DB_HOST/DB_USER/DB_PASSWORD/DB_NAME.');\r\n}\r\n\r\n// Enable SSL automatically for Supabase or when DATABASE_SSL=true\r\nconst useSsl = (process.env.DATABASE_SSL || '').toLowerCase() === 'true' || (connectionString?.includes('supabase.com') || connectionString?.includes('supabase.co'));\r\n\r\nconst pool = new Pool({\r\n  connectionString: connectionString,\r\n  max: 20,\r\n  // Increase timeouts to be more tolerant of transient network/DB latency\r\n  idleTimeoutMillis: 60000,\r\n  connectionTimeoutMillis: 10000,\r\n  keepAlive: true,\r\n  ssl: useSsl ? { rejectUnauthorized: false } : undefined,\r\n});\r\n\r\n// Test connection\r\npool.on('connect', () => {\r\n  console.log('‚úÖ Database connected');\r\n});\r\n\r\npool.on('error', (err) => {\r\n  console.error('‚ùå Unexpected database error:', err);\r\n  // Don't exit process in production, just log the error\r\n  if (process.env.NODE_ENV !== 'production') {\r\n    process.exit(-1);\r\n  }\r\n});\r\n\r\nexport default pool;\r\n\r\n// Export query function\r\nexport const query = pool.query.bind(pool);\r\n\r\n// Safe query with retry for transient connection issues\r\nexport async function safeQuery(text: string, params?: any[]): Promise<QueryResult<any>> {\r\n  const maxAttempts = 3;\r\n  for (let attempt = 1; attempt <= maxAttempts; attempt++) {\r\n    try {\r\n      return await pool.query(text, params);\r\n    } catch (err: any) {\r\n      const msg = err?.message || '';\r\n      const isTransient = msg.includes('Connection terminated') || msg.includes('connection timeout') || msg.includes('Connection terminated unexpectedly') || msg.includes('ECONNRESET') || err?.code === '57P01' || err?.code === 'ECONNRESET' || err?.code === '57P03';\r\n      if (attempt < maxAttempts && isTransient) {\r\n        console.warn(`‚ö†Ô∏è Transient DB error (attempt ${attempt}): ${msg}. Retrying in ${attempt * 300}ms...`);\r\n        await new Promise((resolve) => setTimeout(resolve, attempt * 300));\r\n        continue;\r\n      }\r\n      throw err;\r\n    }\r\n  }\r\n  throw new Error('safeQuery: exhausted retries without success');\r\n}\r\n\r\n// Helper function for transactions\r\nexport async function withTransaction<T>(\r\n  callback: (client: PoolClient) => Promise<T>\r\n): Promise<T> {\r\n  const client = await pool.connect();\r\n  try {\r\n    await client.query('BEGIN');\r\n    const result = await callback(client);\r\n    await client.query('COMMIT');\r\n    return result;\r\n  } catch (error) {\r\n    await client.query('ROLLBACK');\r\n    throw error;\r\n  } finally {\r\n    client.release();\r\n  }\r\n}\r\n\r\n// Common database queries\r\nexport const db = {\r\n  // Users\r\n  async getUserByEmail(email: string) {\r\n    const result = await pool.query(\r\n      'SELECT * FROM users WHERE email = $1',\r\n      [email]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async getUserById(id: string) {\r\n    const result = await pool.query(\r\n      'SELECT id, email, name, created_at FROM users WHERE id = $1',\r\n      [id]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async createUser(email: string, name: string, passwordHash: string) {\r\n    const result = await pool.query(\r\n      'INSERT INTO users (email, name, password_hash) VALUES ($1, $2, $3) RETURNING id, email, name, created_at',\r\n      [email, name, passwordHash]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async updateUserPassword(userId: string, passwordHash: string) {\r\n    await pool.query(\r\n      'UPDATE users SET password_hash = $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2',\r\n      [passwordHash, userId]\r\n    );\r\n  },\r\n\r\n  async updateLastLogin(userId: string) {\r\n    await pool.query(\r\n      'UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = $1',\r\n      [userId]\r\n    );\r\n  },\r\n\r\n  // Verification tokens\r\n  async createVerificationToken(userId: string, token: string, expiresAt: Date) {\r\n    await pool.query(\r\n      'INSERT INTO verification_tokens (user_id, token, expires_at) VALUES ($1, $2, $3)',\r\n      [userId, token, expiresAt]\r\n    );\r\n  },\r\n\r\n  async getVerificationToken(token: string) {\r\n    const result = await pool.query(\r\n      'SELECT * FROM verification_tokens WHERE token = $1 AND expires_at > NOW()',\r\n      [token]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async deleteVerificationToken(token: string) {\r\n    await pool.query('DELETE FROM verification_tokens WHERE token = $1', [token]);\r\n  },\r\n\r\n  // Transactions\r\n  async getTransactions(userId: string, limit = 50, offset = 0) {\r\n    const result = await pool.query(\r\n      `SELECT t.*, c.name as category_name, a.name as account_name \r\n       FROM transactions t\r\n       LEFT JOIN categories c ON t.category_id = c.id\r\n       LEFT JOIN accounts a ON t.account_id = a.id\r\n       WHERE t.user_id = $1\r\n       ORDER BY t.date DESC, t.created_at DESC\r\n       LIMIT $2 OFFSET $3`,\r\n      [userId, limit, offset]\r\n    );\r\n    return result.rows;\r\n  },\r\n\r\n  async createTransaction(userId: string, data: {\r\n    accountId?: string;\r\n    categoryId?: string;\r\n    type: string;\r\n    amount: number;\r\n    description?: string;\r\n    date: Date;\r\n    notes?: string;\r\n  }) {\r\n    const result = await pool.query(\r\n      `INSERT INTO transactions (user_id, account_id, category_id, type, amount, description, date, notes)\r\n       VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\r\n       RETURNING *`,\r\n      [userId, data.accountId, data.categoryId, data.type, data.amount, data.description, data.date, data.notes]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n};\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 264, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/lib/auth.ts"],"sourcesContent":["// Auth utilities for password hashing and token generation\r\nimport bcrypt from 'bcryptjs';\r\nimport { SignJWT, jwtVerify } from 'jose';\r\n\r\nif (!process.env.JWT_SECRET) {\r\n  console.warn('‚ö†Ô∏è  WARNING: JWT_SECRET not set. Using default secret. This is unsafe for production!');\r\n}\r\n\r\nconst JWT_SECRET = new TextEncoder().encode(\r\n  process.env.JWT_SECRET || 'your-secret-key-change-in-production'\r\n);\r\n\r\n// Password hashing\r\nexport async function hashPassword(password: string): Promise<string> {\r\n  return bcrypt.hash(password, 10);\r\n}\r\n\r\nexport async function verifyPassword(password: string, hash: string): Promise<boolean> {\r\n  return bcrypt.compare(password, hash);\r\n}\r\n\r\n// Token generation\r\nexport function generateToken(): string {\r\n  return crypto.randomUUID() + crypto.randomUUID().replace(/-/g, '');\r\n}\r\n\r\n// JWT tokens\r\nexport async function createToken(payload: { userId: string; email: string }): Promise<string> {\r\n  return new SignJWT(payload)\r\n    .setProtectedHeader({ alg: 'HS256' })\r\n    .setIssuedAt()\r\n    .setExpirationTime('7d')\r\n    .sign(JWT_SECRET);\r\n}\r\n\r\nexport async function verifyToken(token: string): Promise<{ userId: string; email: string } | null> {\r\n  try {\r\n    const { payload } = await jwtVerify(token, JWT_SECRET);\r\n    return payload as { userId: string; email: string };\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n\r\n// MFA token (short‚Äëlived, used only to complete 2FA)\r\nexport async function createMfaToken(payload: { userId: string; email: string }): Promise<string> {\r\n  return new SignJWT({ ...payload, mfa: true })\r\n    .setProtectedHeader({ alg: 'HS256' })\r\n    .setIssuedAt()\r\n    .setExpirationTime('5m')\r\n    .sign(JWT_SECRET);\r\n}\r\n\r\nexport async function verifyMfaToken(token: string): Promise<{ userId: string; email: string; mfa: true } | null> {\r\n  try {\r\n    const { payload } = await jwtVerify(token, JWT_SECRET);\r\n    if (payload && (payload as any).mfa === true) {\r\n      return payload as { userId: string; email: string; mfa: true };\r\n    }\r\n    return null;\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport const auth = {\r\n  hashPassword,\r\n  verifyPassword,\r\n  generateToken,\r\n  createToken,\r\n  verifyToken,\r\n  createMfaToken,\r\n  verifyMfaToken,\r\n};\r\n\r\n// Validation schemas\r\nexport const validation = {\r\n  email: (email: string) => /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email),\r\n  \r\n  password: (password: string) => {\r\n    // At least 8 characters, 1 uppercase, 1 lowercase, 1 number\r\n    return password.length >= 8 &&\r\n           /[A-Z]/.test(password) &&\r\n           /[a-z]/.test(password) &&\r\n           /[0-9]/.test(password);\r\n  },\r\n\r\n  passwordMessage: 'Password must be at least 8 characters with 1 uppercase, 1 lowercase, and 1 number',\r\n};\r\n"],"names":[],"mappings":"AAAA,2DAA2D;;;;;;;;;;;;;;;;;;;;;AAC3D;AACA;AAAA;;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,UAAU,EAAE;IAC3B,QAAQ,IAAI,CAAC;AACf;AAEA,MAAM,aAAa,IAAI,cAAc,MAAM,CACzC,QAAQ,GAAG,CAAC,UAAU,IAAI;AAIrB,eAAe,aAAa,QAAgB;IACjD,OAAO,8IAAM,CAAC,IAAI,CAAC,UAAU;AAC/B;AAEO,eAAe,eAAe,QAAgB,EAAE,IAAY;IACjE,OAAO,8IAAM,CAAC,OAAO,CAAC,UAAU;AAClC;AAGO,SAAS;IACd,OAAO,OAAO,UAAU,KAAK,OAAO,UAAU,GAAG,OAAO,CAAC,MAAM;AACjE;AAGO,eAAe,YAAY,OAA0C;IAC1E,OAAO,IAAI,uKAAO,CAAC,SAChB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,MAClB,IAAI,CAAC;AACV;AAEO,eAAe,YAAY,KAAa;IAC7C,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,2KAAS,EAAC,OAAO;QAC3C,OAAO;IACT,EAAE,OAAO,OAAO;QACd,OAAO;IACT;AACF;AAGO,eAAe,eAAe,OAA0C;IAC7E,OAAO,IAAI,uKAAO,CAAC;QAAE,GAAG,OAAO;QAAE,KAAK;IAAK,GACxC,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,MAClB,IAAI,CAAC;AACV;AAEO,eAAe,eAAe,KAAa;IAChD,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,2KAAS,EAAC,OAAO;QAC3C,IAAI,WAAW,AAAC,QAAgB,GAAG,KAAK,MAAM;YAC5C,OAAO;QACT;QACA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,OAAO;IACT;AACF;AAEO,MAAM,OAAO;IAClB;IACA;IACA;IACA;IACA;IACA;IACA;AACF;AAGO,MAAM,aAAa;IACxB,OAAO,CAAC,QAAkB,6BAA6B,IAAI,CAAC;IAE5D,UAAU,CAAC;QACT,4DAA4D;QAC5D,OAAO,SAAS,MAAM,IAAI,KACnB,QAAQ,IAAI,CAAC,aACb,QAAQ,IAAI,CAAC,aACb,QAAQ,IAAI,CAAC;IACtB;IAEA,iBAAiB;AACnB","debugId":null}},
    {"offset": {"line": 380, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/lib/email.ts"],"sourcesContent":["// Email service using Resend\r\nimport { Resend } from 'resend';\r\n\r\n// Initialize Resend only if API key is present to avoid build-time error\r\nconst resendApiKey = process.env.RESEND_API_KEY;\r\nconst resend = resendApiKey ? new Resend(resendApiKey) : null;\r\n\r\nconst FROM_EMAIL = process.env.EMAIL_FROM || 'FinTrackrX <noreply@fintrackrx.com>';\r\nconst APP_URL = process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000';\r\n\r\nexport const emailService = {\r\n  async sendVerificationEmail(to: string, name: string, token: string) {\r\n    const verificationUrl = `${APP_URL}/verify-email?token=${token}`;\r\n\r\n    if (!resend) {\r\n      return { success: false, error: 'RESEND_API_KEY not configured' };\r\n    }\r\n    try {\r\n      await resend.emails.send({\r\n        from: FROM_EMAIL,\r\n        to,\r\n        subject: 'Verify your FinTrackrX account',\r\n        html: `\r\n          <!DOCTYPE html>\r\n          <html>\r\n            <head>\r\n              <meta charset=\"utf-8\">\r\n              <style>\r\n                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\r\n                .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n                .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 8px 8px 0 0; }\r\n                .content { background: #f9fafb; padding: 30px; border-radius: 0 0 8px 8px; }\r\n                .button { display: inline-block; background: #667eea; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; margin: 20px 0; }\r\n                .footer { text-align: center; margin-top: 30px; color: #6b7280; font-size: 12px; }\r\n              </style>\r\n            </head>\r\n            <body>\r\n              <div class=\"container\">\r\n                <div class=\"header\">\r\n                  <h1>Welcome to FinTrackrX!</h1>\r\n                </div>\r\n                <div class=\"content\">\r\n                  <p>Hi ${name},</p>\r\n                  <p>Thanks for signing up! Please verify your email address to get started with FinTrackrX.</p>\r\n                  <p style=\"text-align: center;\">\r\n                    <a href=\"${verificationUrl}\" class=\"button\">Verify Email Address</a>\r\n                  </p>\r\n                  <p>Or copy and paste this link into your browser:</p>\r\n                  <p style=\"word-break: break-all; color: #667eea;\">${verificationUrl}</p>\r\n                  <p>This link will expire in 24 hours.</p>\r\n                  <p>If you didn't create an account, you can safely ignore this email.</p>\r\n                </div>\r\n                <div class=\"footer\">\r\n                  <p>&copy; ${new Date().getFullYear()} FinTrackrX. All rights reserved.</p>\r\n                </div>\r\n              </div>\r\n            </body>\r\n          </html>\r\n        `,\r\n      });\r\n      return { success: true };\r\n    } catch (error) {\r\n      console.error('Email send error:', error);\r\n      return { success: false, error };\r\n    }\r\n  },\r\n\r\n  async sendPasswordResetEmail(to: string, name: string, token: string) {\r\n    const resetUrl = `${APP_URL}/reset-password?token=${token}`;\r\n\r\n    if (!resend) {\r\n      return { success: false, error: 'RESEND_API_KEY not configured' };\r\n    }\r\n    try {\r\n      await resend.emails.send({\r\n        from: FROM_EMAIL,\r\n        to,\r\n        subject: 'Reset your FinTrackrX password',\r\n        html: `\r\n          <!DOCTYPE html>\r\n          <html>\r\n            <head>\r\n              <meta charset=\"utf-8\">\r\n              <style>\r\n                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\r\n                .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n                .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 8px 8px 0 0; }\r\n                .content { background: #f9fafb; padding: 30px; border-radius: 0 0 8px 8px; }\r\n                .button { display: inline-block; background: #ef4444; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; margin: 20px 0; }\r\n                .footer { text-align: center; margin-top: 30px; color: #6b7280; font-size: 12px; }\r\n              </style>\r\n            </head>\r\n            <body>\r\n              <div class=\"container\">\r\n                <div class=\"header\">\r\n                  <h1>Reset Your Password</h1>\r\n                </div>\r\n                <div class=\"content\">\r\n                  <p>Hi ${name},</p>\r\n                  <p>We received a request to reset your password for your FinTrackrX account.</p>\r\n                  <p style=\"text-align: center;\">\r\n                    <a href=\"${resetUrl}\" class=\"button\">Reset Password</a>\r\n                  </p>\r\n                  <p>Or copy and paste this link into your browser:</p>\r\n                  <p style=\"word-break: break-all; color: #667eea;\">${resetUrl}</p>\r\n                  <p>This link will expire in 1 hour.</p>\r\n                  <p><strong>If you didn't request this,</strong> please ignore this email and your password will remain unchanged.</p>\r\n                </div>\r\n                <div class=\"footer\">\r\n                  <p>&copy; ${new Date().getFullYear()} FinTrackrX. All rights reserved.</p>\r\n                </div>\r\n              </div>\r\n            </body>\r\n          </html>\r\n        `,\r\n      });\r\n      return { success: true };\r\n    } catch (error) {\r\n      console.error('Email send error:', error);\r\n      return { success: false, error };\r\n    }\r\n  },\r\n\r\n  async sendTransactionAlert(to: string, name: string, transaction: {\r\n    type: string;\r\n    amount: number;\r\n    description: string;\r\n    date: string;\r\n  }) {\r\n    if (!resend) {\r\n      return { success: false, error: 'RESEND_API_KEY not configured' };\r\n    }\r\n    try {\r\n      await resend.emails.send({\r\n        from: FROM_EMAIL,\r\n        to,\r\n        subject: `Transaction Alert: ${transaction.type === 'expense' ? '-' : '+'}‚Çπ${transaction.amount}`,\r\n        html: `\r\n          <!DOCTYPE html>\r\n          <html>\r\n            <head>\r\n              <meta charset=\"utf-8\">\r\n              <style>\r\n                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\r\n                .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n                .header { background: ${transaction.type === 'expense' ? '#ef4444' : '#10b981'}; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }\r\n                .content { background: #f9fafb; padding: 30px; border-radius: 0 0 8px 8px; }\r\n                .amount { font-size: 32px; font-weight: bold; color: ${transaction.type === 'expense' ? '#ef4444' : '#10b981'}; }\r\n                .footer { text-align: center; margin-top: 30px; color: #6b7280; font-size: 12px; }\r\n              </style>\r\n            </head>\r\n            <body>\r\n              <div class=\"container\">\r\n                <div class=\"header\">\r\n                  <h1>${transaction.type === 'expense' ? 'üí∏' : 'üí∞'} Transaction Alert</h1>\r\n                </div>\r\n                <div class=\"content\">\r\n                  <p>Hi ${name},</p>\r\n                  <p>A new ${transaction.type} has been recorded:</p>\r\n                  <p class=\"amount\">${transaction.type === 'expense' ? '-' : '+'}‚Çπ${transaction.amount}</p>\r\n                  <p><strong>Description:</strong> ${transaction.description}</p>\r\n                  <p><strong>Date:</strong> ${transaction.date}</p>\r\n                  <p style=\"text-align: center; margin-top: 30px;\">\r\n                    <a href=\"${APP_URL}/dashboard\" style=\"display: inline-block; background: #667eea; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px;\">View Dashboard</a>\r\n                  </p>\r\n                </div>\r\n                <div class=\"footer\">\r\n                  <p>&copy; ${new Date().getFullYear()} FinTrackrX. All rights reserved.</p>\r\n                </div>\r\n              </div>\r\n            </body>\r\n          </html>\r\n        `,\r\n      });\r\n      return { success: true };\r\n    } catch (error) {\r\n      console.error('Email send error:', error);\r\n      return { success: false, error };\r\n    }\r\n  },\r\n\r\n  async sendBudgetAlert(to: string, name: string, budget: {\r\n    name: string;\r\n    spent: number;\r\n    limit: number;\r\n    percentage: number;\r\n  }) {\r\n    if (!resend) {\r\n      return { success: false, error: 'RESEND_API_KEY not configured' };\r\n    }\r\n    try {\r\n      await resend.emails.send({\r\n        from: FROM_EMAIL,\r\n        to,\r\n        subject: `Budget Alert: ${budget.name} at ${budget.percentage}%`,\r\n        html: `\r\n          <!DOCTYPE html>\r\n          <html>\r\n            <head>\r\n              <meta charset=\"utf-8\">\r\n              <style>\r\n                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\r\n                .container { max-width: 600px; margin: 0 auto; padding: 20px; }\r\n                .header { background: #f59e0b; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }\r\n                .content { background: #f9fafb; padding: 30px; border-radius: 0 0 8px 8px; }\r\n                .progress-bar { height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden; }\r\n                .progress-fill { height: 100%; background: ${budget.percentage >= 90 ? '#ef4444' : '#f59e0b'}; }\r\n                .footer { text-align: center; margin-top: 30px; color: #6b7280; font-size: 12px; }\r\n              </style>\r\n            </head>\r\n            <body>\r\n              <div class=\"container\">\r\n                <div class=\"header\">\r\n                  <h1>‚ö†Ô∏è Budget Alert</h1>\r\n                </div>\r\n                <div class=\"content\">\r\n                  <p>Hi ${name},</p>\r\n                  <p>Your <strong>${budget.name}</strong> budget is at <strong>${budget.percentage}%</strong></p>\r\n                  <div class=\"progress-bar\">\r\n                    <div class=\"progress-fill\" style=\"width: ${budget.percentage}%\"></div>\r\n                  </div>\r\n                  <p style=\"margin-top: 20px;\">\r\n                    <strong>Spent:</strong> ‚Çπ${budget.spent.toLocaleString()}<br>\r\n                    <strong>Budget:</strong> ‚Çπ${budget.limit.toLocaleString()}<br>\r\n                    <strong>Remaining:</strong> ‚Çπ${(budget.limit - budget.spent).toLocaleString()}\r\n                  </p>\r\n                  ${budget.percentage >= 90 ? '<p style=\"color: #ef4444;\"><strong>Warning:</strong> You\\'re close to exceeding your budget!</p>' : ''}\r\n                  <p style=\"text-align: center; margin-top: 30px;\">\r\n                    <a href=\"${APP_URL}/dashboard\" style=\"display: inline-block; background: #667eea; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px;\">View Budget Details</a>\r\n                  </p>\r\n                </div>\r\n                <div class=\"footer\">\r\n                  <p>&copy; ${new Date().getFullYear()} FinTrackrX. All rights reserved.</p>\r\n                </div>\r\n              </div>\r\n            </body>\r\n          </html>\r\n        `,\r\n      });\r\n      return { success: true };\r\n    } catch (error) {\r\n      console.error('Email send error:', error);\r\n      return { success: false, error };\r\n    }\r\n  },\r\n\r\n  async sendMfaEmailCode(to: string, name: string | undefined, code: string) {\r\n    if (!resend) {\r\n      return { success: false, error: 'RESEND_API_KEY not configured' };\r\n    }\r\n    try {\r\n      await resend.emails.send({\r\n        from: FROM_EMAIL,\r\n        to,\r\n        subject: 'Your FinTrackrX sign-in code',\r\n        html: `\r\n          <!DOCTYPE html>\r\n          <html>\r\n            <head>\r\n              <meta charset=\"utf-8\">\r\n              <style>\r\n                body { font-family: Arial, sans-serif; line-height: 1.6; color: #111827; background: #f9fafb; }\r\n                .container { max-width: 560px; margin: 0 auto; padding: 20px; }\r\n                .card { background: #ffffff; border: 1px solid #e5e7eb; border-radius: 10px; overflow: hidden; }\r\n                .header { background: linear-gradient(135deg, #111827 0%, #1f2937 100%); color: white; padding: 24px; text-align: center; }\r\n                .content { padding: 24px; }\r\n                .code { font-size: 32px; font-weight: 700; letter-spacing: 6px; background: #f3f4f6; padding: 12px 16px; border-radius: 8px; text-align: center; }\r\n                .muted { color: #6b7280; font-size: 12px; }\r\n              </style>\r\n            </head>\r\n            <body>\r\n              <div class=\"container\">\r\n                <div class=\"card\">\r\n                  <div class=\"header\">\r\n                    <h1>Sign-in code</h1>\r\n                  </div>\r\n                  <div class=\"content\">\r\n                    <p>Hi ${name || 'there'},</p>\r\n                    <p>Use the following code to finish signing in to FinTrackrX:</p>\r\n                    <div class=\"code\">${code}</div>\r\n                    <p class=\"muted\">This code expires in 10 minutes. If you didn‚Äôt request it, you can ignore this email.</p>\r\n                  </div>\r\n                </div>\r\n                <p class=\"muted\" style=\"text-align:center;margin-top:12px;\">&copy; ${new Date().getFullYear()} FinTrackrX</p>\r\n              </div>\r\n            </body>\r\n          </html>\r\n        `,\r\n      });\r\n      return { success: true };\r\n    } catch (error) {\r\n      console.error('Email send error (MFA code):', error);\r\n      return { success: false, error };\r\n    }\r\n  },\r\n};\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 708, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/app/api/auth/signup/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { db } from '@/lib/db';\r\nimport { auth, validation } from '@/lib/auth';\r\nimport { emailService } from '@/lib/email';\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const { name, email, password } = await req.json();\r\n\r\n    // Validation\r\n    if (!name || !email || !password) {\r\n      return NextResponse.json(\r\n        { error: 'All fields are required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (!validation.email(email)) {\r\n      return NextResponse.json(\r\n        { error: 'Invalid email address' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (!validation.password(password)) {\r\n      return NextResponse.json(\r\n        { error: validation.passwordMessage },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Check if user exists\r\n    const existingUser = await db.getUserByEmail(email.toLowerCase());\r\n    if (existingUser) {\r\n      return NextResponse.json(\r\n        { error: 'Email already registered' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Hash password\r\n    const passwordHash = await auth.hashPassword(password);\r\n\r\n    // Create user\r\n    const user = await db.createUser(email.toLowerCase(), name, passwordHash);\r\n\r\n    // Generate verification token\r\n    const verificationToken = auth.generateToken();\r\n    const expiresAt = new Date(Date.now() + 24 * 60 * 60 * 1000); // 24 hours\r\n    await db.createVerificationToken(user.id, verificationToken, expiresAt);\r\n\r\n    // Send verification email\r\n    await emailService.sendVerificationEmail(email, name, verificationToken);\r\n\r\n    // Create JWT token for immediate login (optional - can require verification first)\r\n    const token = await auth.createToken({ userId: user.id, email: user.email });\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: 'Account created! Please check your email to verify your account.',\r\n      user: {\r\n        id: user.id,\r\n        email: user.email,\r\n        name: user.name,\r\n      },\r\n      token,\r\n    });\r\n  } catch (error) {\r\n    console.error('Signup error:', error);\r\n    return NextResponse.json(\r\n      { error: 'Failed to create account' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;;;;;AAEO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,MAAM,IAAI,IAAI;QAEhD,aAAa;QACb,IAAI,CAAC,QAAQ,CAAC,SAAS,CAAC,UAAU;YAChC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,CAAC,2HAAU,CAAC,KAAK,CAAC,QAAQ;YAC5B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAwB,GACjC;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,CAAC,2HAAU,CAAC,QAAQ,CAAC,WAAW;YAClC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO,2HAAU,CAAC,eAAe;YAAC,GACpC;gBAAE,QAAQ;YAAI;QAElB;QAEA,uBAAuB;QACvB,MAAM,eAAe,MAAM,iHAAE,CAAC,cAAc,CAAC,MAAM,WAAW;QAC9D,IAAI,cAAc;YAChB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA2B,GACpC;gBAAE,QAAQ;YAAI;QAElB;QAEA,gBAAgB;QAChB,MAAM,eAAe,MAAM,qHAAI,CAAC,YAAY,CAAC;QAE7C,cAAc;QACd,MAAM,OAAO,MAAM,iHAAE,CAAC,UAAU,CAAC,MAAM,WAAW,IAAI,MAAM;QAE5D,8BAA8B;QAC9B,MAAM,oBAAoB,qHAAI,CAAC,aAAa;QAC5C,MAAM,YAAY,IAAI,KAAK,KAAK,GAAG,KAAK,KAAK,KAAK,KAAK,OAAO,WAAW;QACzE,MAAM,iHAAE,CAAC,uBAAuB,CAAC,KAAK,EAAE,EAAE,mBAAmB;QAE7D,0BAA0B;QAC1B,MAAM,8HAAY,CAAC,qBAAqB,CAAC,OAAO,MAAM;QAEtD,mFAAmF;QACnF,MAAM,QAAQ,MAAM,qHAAI,CAAC,WAAW,CAAC;YAAE,QAAQ,KAAK,EAAE;YAAE,OAAO,KAAK,KAAK;QAAC;QAE1E,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;YACT,MAAM;gBACJ,IAAI,KAAK,EAAE;gBACX,OAAO,KAAK,KAAK;gBACjB,MAAM,KAAK,IAAI;YACjB;YACA;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,iBAAiB;QAC/B,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAA2B,GACpC;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}