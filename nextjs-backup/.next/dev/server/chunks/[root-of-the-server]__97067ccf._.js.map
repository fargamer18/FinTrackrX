{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/app/api/ai/health/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\n\r\n// Reuse Gemini configuration from advisor route for consistency\r\nconst GEMINI_API_KEY = process.env.GEMINI_API_KEY || process.env.GOOGLE_API_KEY;\r\nconst GEMINI_API_VERSION = (process.env.GEMINI_API_VERSION || 'v1beta').trim();\r\nconst GEMINI_MODEL = (process.env.GEMINI_MODEL || 'gemini-1.5-flash-latest').trim();\r\nconst GEMINI_API_URL = (process.env.GEMINI_API_URL || `https://generativelanguage.googleapis.com/${GEMINI_API_VERSION}/models/${GEMINI_MODEL}:generateContent`).trim();\r\n\r\ninterface FinancialData {\r\n  monthlyIncome: number;\r\n  monthlyExpenses: number;\r\n  balance: number;\r\n  savingsRate: number;\r\n  expenseRatio: number;\r\n  transactions: { type: string; category: string; amount: number; date: string }[];\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  let parsed: { financialData?: FinancialData } = {};\r\n  try {\r\n    parsed = await request.json();\r\n    const { financialData } = parsed;\r\n    if (!financialData) {\r\n      return NextResponse.json({ error: 'financialData is required' }, { status: 400 });\r\n    }\r\n\r\n    // Lightweight RAG context: summarize top categories & recent transactions\r\n    const categoryTotals: Record<string, number> = {};\r\n    financialData.transactions.slice(0, 50).forEach(tx => {\r\n      const key = `${tx.type}:${tx.category}`;\r\n      categoryTotals[key] = (categoryTotals[key] || 0) + tx.amount;\r\n    });\r\n    const topCategories = Object.entries(categoryTotals)\r\n      .sort((a, b) => b[1] - a[1])\r\n      .slice(0, 6)\r\n      .map(([k, v]) => `${k} = ₹${v.toLocaleString()}`)\r\n      .join('\\n');\r\n\r\n    // Heuristic fallback score if AI unavailable\r\n    const heuristicScore = (() => {\r\n      let score = 50;\r\n      const { savingsRate, expenseRatio } = financialData;\r\n      if (savingsRate >= 30) score += 30; else if (savingsRate >= 20) score += 25; else if (savingsRate >= 10) score += 15; else if (savingsRate > 0) score += 5;\r\n      if (expenseRatio <= 50) score += 20; else if (expenseRatio <= 70) score += 10;\r\n      return Math.min(100, Math.max(0, score));\r\n    })();\r\n\r\n    if (!GEMINI_API_KEY) {\r\n      return NextResponse.json({\r\n        score: heuristicScore,\r\n        summary: 'Heuristic score based on savings rate and expense ratio. Set GEMINI_API_KEY to enable AI analysis.',\r\n        source: 'fallback'\r\n      });\r\n    }\r\n\r\n    const prompt = `You are an expert financial analyst for Indian personal finance. Given the user's data, produce a JSON response with the following keys: score (0-100 integer), summary (1-2 sentence plain text), and rationale (concise bullet-style explanation). Score criteria: savings rate quality, expense control, balance trend potential. DO NOT wrap in markdown.\r\n\r\nUser Data:\r\nMonthly Income: ₹${financialData.monthlyIncome.toLocaleString()}\r\nMonthly Expenses: ₹${financialData.monthlyExpenses.toLocaleString()}\r\nBalance: ₹${financialData.balance.toLocaleString()}\r\nSavings Rate: ${financialData.savingsRate.toFixed(1)}%\r\nExpense Ratio: ${financialData.expenseRatio.toFixed(1)}%\r\nTop Categories:\\n${topCategories || 'None'}\r\nRecent Transactions (first 10):\\n${financialData.transactions.slice(0,10).map(t => `${t.type} ${t.category} ₹${t.amount}`).join('\\n')}\r\n\r\nReturn ONLY valid JSON.`;\r\n\r\n    const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        contents: [ { role: 'user', parts: [ { text: prompt } ] } ],\r\n        generationConfig: { maxOutputTokens: 220, temperature: 0.4, topP: 0.9 }\r\n      })\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const err = await response.text();\r\n      console.error('Gemini health error:', err);\r\n      return NextResponse.json({ score: heuristicScore, summary: 'Fallback heuristic applied due to AI error.', source: 'fallback' });\r\n    }\r\n\r\n    const result = await response.json();\r\n    let text = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';\r\n    // Attempt to extract JSON\r\n    let json: any = {};\r\n    try {\r\n      // Remove potential markdown fences\r\n      text = text.replace(/^```json/i, '').replace(/```$/i, '').trim();\r\n      json = JSON.parse(text);\r\n    } catch (e) {\r\n      console.warn('Failed to parse AI JSON, using heuristic.', text);\r\n      return NextResponse.json({ score: heuristicScore, summary: 'AI response unparsable; heuristic used.', source: 'fallback' });\r\n    }\r\n\r\n    const score = typeof json.score === 'number' ? Math.min(100, Math.max(0, Math.round(json.score))) : heuristicScore;\r\n    const summary = typeof json.summary === 'string' && json.summary.length > 0 ? json.summary : 'AI generated summary unavailable.';\r\n\r\n    return NextResponse.json({ score, summary, source: 'ai' });\r\n  } catch (error) {\r\n    console.error('Health endpoint error', error);\r\n    const { financialData } = parsed;\r\n    let fallbackScore = 50;\r\n    if (financialData) {\r\n      if (financialData.savingsRate >= 30) fallbackScore += 30; else if (financialData.savingsRate >= 20) fallbackScore += 25; else if (financialData.savingsRate >= 10) fallbackScore += 15; else if (financialData.savingsRate > 0) fallbackScore += 5;\r\n      if (financialData.expenseRatio <= 50) fallbackScore += 20; else if (financialData.expenseRatio <= 70) fallbackScore += 10;\r\n      fallbackScore = Math.min(100, Math.max(0, fallbackScore));\r\n    }\r\n    return NextResponse.json({ score: fallbackScore, summary: 'Unexpected error. Heuristic score provided.', source: 'fallback' });\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}