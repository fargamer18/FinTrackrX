{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/app/api/ai/recommendations/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\n\r\nconst GEMINI_API_KEY = process.env.GEMINI_API_KEY || process.env.GOOGLE_API_KEY;\r\nconst GEMINI_API_VERSION = (process.env.GEMINI_API_VERSION || 'v1beta').trim();\r\nconst GEMINI_MODEL = (process.env.GEMINI_MODEL || 'gemini-1.5-flash-latest').trim();\r\nconst GEMINI_API_URL = (process.env.GEMINI_API_URL || `https://generativelanguage.googleapis.com/${GEMINI_API_VERSION}/models/${GEMINI_MODEL}:generateContent`).trim();\r\n\r\ninterface FinancialData {\r\n  monthlyIncome: number;\r\n  monthlyExpenses: number;\r\n  balance: number;\r\n  savingsRate: number;\r\n  expenseRatio: number;\r\n  transactions: { type: string; category: string; amount: number; date: string }[];\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  let parsed: { financialData?: FinancialData } = {};\r\n  try {\r\n    parsed = await request.json();\r\n    const { financialData } = parsed;\r\n    if (!financialData) {\r\n      return NextResponse.json({ error: 'financialData is required' }, { status: 400 });\r\n    }\r\n\r\n    // Fallback basic recs\r\n    const buildFallback = () => {\r\n      const items: { title: string; desc: string }[] = [];\r\n      if (financialData.savingsRate < 20) {\r\n        const needed = Math.max(0, Math.round(financialData.monthlyIncome * 0.2 - (financialData.monthlyIncome - financialData.monthlyExpenses)));\r\n        items.push({ title: 'Boost Savings Rate', desc: `Aim to save ₹${needed.toLocaleString()} more monthly by reducing discretionary spends and automating transfers.` });\r\n      }\r\n      if (financialData.expenseRatio > 70) {\r\n        items.push({ title: 'Trim Expense Ratio', desc: 'Target expense ratio below 70% by renegotiating bills, cutting subscriptions, and setting category caps.' });\r\n      }\r\n      if (items.length === 0) {\r\n        items.push({ title: 'Build Emergency Fund', desc: `Target 6 months expenses: ₹${(financialData.monthlyExpenses * 6).toLocaleString()}. Park in liquid funds.` });\r\n        items.push({ title: 'Systematic Investing', desc: 'Start/scale a SIP in diversified index funds for long-term goals.' });\r\n      }\r\n      return items;\r\n    };\r\n\r\n    if (!GEMINI_API_KEY) {\r\n      return NextResponse.json({ items: buildFallback(), source: 'fallback' });\r\n    }\r\n\r\n    const condensedTx = financialData.transactions.slice(0, 25).map(t => `${t.type} ${t.category} ₹${t.amount}`).join('\\n');\r\n    const prompt = `You are a personal finance coach for Indian users. Based on the user's data and spending patterns, return JSON with an array \"items\" of 3-6 prioritized recommendations, each with {\"title\": string, \"desc\": string}. Keep advice practical and specific. No markdown.\r\n\r\nUser Data:\r\nIncome: ₹${financialData.monthlyIncome.toLocaleString()}  |  Expenses: ₹${financialData.monthlyExpenses.toLocaleString()}  |  Savings Rate: ${financialData.savingsRate.toFixed(1)}%  |  Expense Ratio: ${financialData.expenseRatio.toFixed(1)}%\r\nRecent Transactions (up to 25):\\n${condensedTx || 'None'}\r\n\r\nReturn ONLY valid JSON like {\"items\":[{\"title\":\"...\",\"desc\":\"...\"}, ...]}.`;\r\n\r\n    const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({\r\n        contents: [ { role: 'user', parts: [ { text: prompt } ] } ],\r\n        generationConfig: { maxOutputTokens: 280, temperature: 0.5, topP: 0.9 }\r\n      })\r\n    });\r\n\r\n    if (!response.ok) {\r\n      const err = await response.text();\r\n      console.error('Gemini recs error:', err);\r\n      return NextResponse.json({ items: buildFallback(), source: 'fallback' });\r\n    }\r\n\r\n    const result = await response.json();\r\n    let text = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';\r\n    try {\r\n      text = text.replace(/^```json/i, '').replace(/```$/i, '').trim();\r\n      const parsed = JSON.parse(text);\r\n      const items = Array.isArray(parsed.items) ? parsed.items : [];\r\n      if (items.length > 0) return NextResponse.json({ items, source: 'ai' });\r\n      return NextResponse.json({ items: buildFallback(), source: 'fallback' });\r\n    } catch (e) {\r\n      console.warn('Failed to parse recs JSON; using fallback.', text);\r\n      return NextResponse.json({ items: buildFallback(), source: 'fallback' });\r\n    }\r\n  } catch (error) {\r\n    console.error('Recommendations endpoint error', error);\r\n    return NextResponse.json({ items: [\r\n      { title: 'Stabilize Finances', desc: 'Reduce high-variance expenses and set category caps to improve predictability.' },\r\n      { title: 'Automate Savings', desc: 'Set an auto-transfer the day income arrives; start with 10–20%.' },\r\n    ], source: 'fallback' });\r\n  }\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}