{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/lib/auth.ts"],"sourcesContent":["// Auth utilities for password hashing and token generation\r\nimport bcrypt from 'bcryptjs';\r\nimport { SignJWT, jwtVerify } from 'jose';\r\n\r\nif (!process.env.JWT_SECRET) {\r\n  console.warn('⚠️  WARNING: JWT_SECRET not set. Using default secret. This is unsafe for production!');\r\n}\r\n\r\nconst JWT_SECRET = new TextEncoder().encode(\r\n  process.env.JWT_SECRET || 'your-secret-key-change-in-production'\r\n);\r\n\r\n// Password hashing\r\nexport async function hashPassword(password: string): Promise<string> {\r\n  return bcrypt.hash(password, 10);\r\n}\r\n\r\nexport async function verifyPassword(password: string, hash: string): Promise<boolean> {\r\n  return bcrypt.compare(password, hash);\r\n}\r\n\r\n// Token generation\r\nexport function generateToken(): string {\r\n  return crypto.randomUUID() + crypto.randomUUID().replace(/-/g, '');\r\n}\r\n\r\n// JWT tokens\r\nexport async function createToken(payload: { userId: string; email: string }): Promise<string> {\r\n  return new SignJWT(payload)\r\n    .setProtectedHeader({ alg: 'HS256' })\r\n    .setIssuedAt()\r\n    .setExpirationTime('7d')\r\n    .sign(JWT_SECRET);\r\n}\r\n\r\nexport async function verifyToken(token: string): Promise<{ userId: string; email: string } | null> {\r\n  try {\r\n    const { payload } = await jwtVerify(token, JWT_SECRET);\r\n    return payload as { userId: string; email: string };\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n\r\n// MFA token (short‑lived, used only to complete 2FA)\r\nexport async function createMfaToken(payload: { userId: string; email: string }): Promise<string> {\r\n  return new SignJWT({ ...payload, mfa: true })\r\n    .setProtectedHeader({ alg: 'HS256' })\r\n    .setIssuedAt()\r\n    .setExpirationTime('5m')\r\n    .sign(JWT_SECRET);\r\n}\r\n\r\nexport async function verifyMfaToken(token: string): Promise<{ userId: string; email: string; mfa: true } | null> {\r\n  try {\r\n    const { payload } = await jwtVerify(token, JWT_SECRET);\r\n    if (payload && (payload as any).mfa === true) {\r\n      return payload as { userId: string; email: string; mfa: true };\r\n    }\r\n    return null;\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport const auth = {\r\n  hashPassword,\r\n  verifyPassword,\r\n  generateToken,\r\n  createToken,\r\n  verifyToken,\r\n  createMfaToken,\r\n  verifyMfaToken,\r\n};\r\n\r\n// Validation schemas\r\nexport const validation = {\r\n  email: (email: string) => /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email),\r\n  \r\n  password: (password: string) => {\r\n    // At least 8 characters, 1 uppercase, 1 lowercase, 1 number\r\n    return password.length >= 8 &&\r\n           /[A-Z]/.test(password) &&\r\n           /[a-z]/.test(password) &&\r\n           /[0-9]/.test(password);\r\n  },\r\n\r\n  passwordMessage: 'Password must be at least 8 characters with 1 uppercase, 1 lowercase, and 1 number',\r\n};\r\n"],"names":[],"mappings":"AAAA,2DAA2D;;;;;;;;;;;;;;;;;;;;;AAC3D;AACA;AAAA;;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,UAAU,EAAE;IAC3B,QAAQ,IAAI,CAAC;AACf;AAEA,MAAM,aAAa,IAAI,cAAc,MAAM,CACzC,QAAQ,GAAG,CAAC,UAAU,IAAI;AAIrB,eAAe,aAAa,QAAgB;IACjD,OAAO,8IAAM,CAAC,IAAI,CAAC,UAAU;AAC/B;AAEO,eAAe,eAAe,QAAgB,EAAE,IAAY;IACjE,OAAO,8IAAM,CAAC,OAAO,CAAC,UAAU;AAClC;AAGO,SAAS;IACd,OAAO,OAAO,UAAU,KAAK,OAAO,UAAU,GAAG,OAAO,CAAC,MAAM;AACjE;AAGO,eAAe,YAAY,OAA0C;IAC1E,OAAO,IAAI,uKAAO,CAAC,SAChB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,MAClB,IAAI,CAAC;AACV;AAEO,eAAe,YAAY,KAAa;IAC7C,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,2KAAS,EAAC,OAAO;QAC3C,OAAO;IACT,EAAE,OAAO,OAAO;QACd,OAAO;IACT;AACF;AAGO,eAAe,eAAe,OAA0C;IAC7E,OAAO,IAAI,uKAAO,CAAC;QAAE,GAAG,OAAO;QAAE,KAAK;IAAK,GACxC,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,MAClB,IAAI,CAAC;AACV;AAEO,eAAe,eAAe,KAAa;IAChD,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,2KAAS,EAAC,OAAO;QAC3C,IAAI,WAAW,AAAC,QAAgB,GAAG,KAAK,MAAM;YAC5C,OAAO;QACT;QACA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,OAAO;IACT;AACF;AAEO,MAAM,OAAO;IAClB;IACA;IACA;IACA;IACA;IACA;IACA;AACF;AAGO,MAAM,aAAa;IACxB,OAAO,CAAC,QAAkB,6BAA6B,IAAI,CAAC;IAE5D,UAAU,CAAC;QACT,4DAA4D;QAC5D,OAAO,SAAS,MAAM,IAAI,KACnB,QAAQ,IAAI,CAAC,aACb,QAAQ,IAAI,CAAC,aACb,QAAQ,IAAI,CAAC;IACtB;IAEA,iBAAiB;AACnB","debugId":null}},
    {"offset": {"line": 174, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/lib/db.ts"],"sourcesContent":["// Database connection pool for PostgreSQL\r\nimport { Pool, PoolClient, QueryResult } from 'pg';\r\n\r\nif (!process.env.DATABASE_URL) {\r\n  console.warn('⚠️  WARNING: DATABASE_URL not set. Database operations will fail.');\r\n}\r\n\r\nconst pool = new Pool({\r\n  connectionString: process.env.DATABASE_URL,\r\n  max: 20,\r\n  // Increase timeouts to be more tolerant of transient network/DB latency\r\n  idleTimeoutMillis: 60000,\r\n  connectionTimeoutMillis: 10000,\r\n});\r\n\r\n// Test connection\r\npool.on('connect', () => {\r\n  console.log('✅ Database connected');\r\n});\r\n\r\npool.on('error', (err) => {\r\n  console.error('❌ Unexpected database error:', err);\r\n  // Don't exit process in production, just log the error\r\n  if (process.env.NODE_ENV !== 'production') {\r\n    process.exit(-1);\r\n  }\r\n});\r\n\r\nexport default pool;\r\n\r\n// Export query function\r\nexport const query = pool.query.bind(pool);\r\n\r\n// Safe query with retry for transient connection issues\r\nexport async function safeQuery(text: string, params?: any[]): Promise<QueryResult<any>> {\r\n  const maxAttempts = 3;\r\n  for (let attempt = 1; attempt <= maxAttempts; attempt++) {\r\n    try {\r\n      return await pool.query(text, params);\r\n    } catch (err: any) {\r\n      const msg = err?.message || '';\r\n      const isTransient = msg.includes('Connection terminated') || msg.includes('connection timeout') || msg.includes('Connection terminated unexpectedly') || msg.includes('ECONNRESET') || err?.code === '57P01' || err?.code === 'ECONNRESET' || err?.code === '57P03';\r\n      if (attempt < maxAttempts && isTransient) {\r\n        console.warn(`⚠️ Transient DB error (attempt ${attempt}): ${msg}. Retrying in ${attempt * 300}ms...`);\r\n        await new Promise((resolve) => setTimeout(resolve, attempt * 300));\r\n        continue;\r\n      }\r\n      throw err;\r\n    }\r\n  }\r\n  throw new Error('safeQuery: exhausted retries without success');\r\n}\r\n\r\n// Helper function for transactions\r\nexport async function withTransaction<T>(\r\n  callback: (client: PoolClient) => Promise<T>\r\n): Promise<T> {\r\n  const client = await pool.connect();\r\n  try {\r\n    await client.query('BEGIN');\r\n    const result = await callback(client);\r\n    await client.query('COMMIT');\r\n    return result;\r\n  } catch (error) {\r\n    await client.query('ROLLBACK');\r\n    throw error;\r\n  } finally {\r\n    client.release();\r\n  }\r\n}\r\n\r\n// Common database queries\r\nexport const db = {\r\n  // Users\r\n  async getUserByEmail(email: string) {\r\n    const result = await pool.query(\r\n      'SELECT * FROM users WHERE email = $1',\r\n      [email]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async getUserById(id: string) {\r\n    const result = await pool.query(\r\n      'SELECT id, email, name, created_at FROM users WHERE id = $1',\r\n      [id]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async createUser(email: string, name: string, passwordHash: string) {\r\n    const result = await pool.query(\r\n      'INSERT INTO users (email, name, password_hash) VALUES ($1, $2, $3) RETURNING id, email, name, created_at',\r\n      [email, name, passwordHash]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async updateUserPassword(userId: string, passwordHash: string) {\r\n    await pool.query(\r\n      'UPDATE users SET password_hash = $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2',\r\n      [passwordHash, userId]\r\n    );\r\n  },\r\n\r\n  async updateLastLogin(userId: string) {\r\n    await pool.query(\r\n      'UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = $1',\r\n      [userId]\r\n    );\r\n  },\r\n\r\n  // Verification tokens\r\n  async createVerificationToken(userId: string, token: string, expiresAt: Date) {\r\n    await pool.query(\r\n      'INSERT INTO verification_tokens (user_id, token, expires_at) VALUES ($1, $2, $3)',\r\n      [userId, token, expiresAt]\r\n    );\r\n  },\r\n\r\n  async getVerificationToken(token: string) {\r\n    const result = await pool.query(\r\n      'SELECT * FROM verification_tokens WHERE token = $1 AND expires_at > NOW()',\r\n      [token]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async deleteVerificationToken(token: string) {\r\n    await pool.query('DELETE FROM verification_tokens WHERE token = $1', [token]);\r\n  },\r\n\r\n  // Transactions\r\n  async getTransactions(userId: string, limit = 50, offset = 0) {\r\n    const result = await pool.query(\r\n      `SELECT t.*, c.name as category_name, a.name as account_name \r\n       FROM transactions t\r\n       LEFT JOIN categories c ON t.category_id = c.id\r\n       LEFT JOIN accounts a ON t.account_id = a.id\r\n       WHERE t.user_id = $1\r\n       ORDER BY t.date DESC, t.created_at DESC\r\n       LIMIT $2 OFFSET $3`,\r\n      [userId, limit, offset]\r\n    );\r\n    return result.rows;\r\n  },\r\n\r\n  async createTransaction(userId: string, data: {\r\n    accountId?: string;\r\n    categoryId?: string;\r\n    type: string;\r\n    amount: number;\r\n    description?: string;\r\n    date: Date;\r\n    notes?: string;\r\n  }) {\r\n    const result = await pool.query(\r\n      `INSERT INTO transactions (user_id, account_id, category_id, type, amount, description, date, notes)\r\n       VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\r\n       RETURNING *`,\r\n      [userId, data.accountId, data.categoryId, data.type, data.amount, data.description, data.date, data.notes]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n};\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 336, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/lib/totp.ts"],"sourcesContent":["import crypto from 'crypto';\r\n\r\n// Base32 encoding for secrets (RFC 4648, without padding)\r\nconst alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';\r\n\r\nexport function randomBase32(length = 32) {\r\n  const bytes = crypto.randomBytes(length);\r\n  return toBase32(bytes);\r\n}\r\n\r\nexport function toBase32(buffer: Buffer) {\r\n  let bits = 0;\r\n  let value = 0;\r\n  let output = '';\r\n  for (let i = 0; i < buffer.length; i++) {\r\n    value = (value << 8) | buffer[i];\r\n    bits += 8;\r\n    while (bits >= 5) {\r\n      output += alphabet[(value >>> (bits - 5)) & 31];\r\n      bits -= 5;\r\n    }\r\n  }\r\n  if (bits > 0) {\r\n    output += alphabet[(value << (5 - bits)) & 31];\r\n  }\r\n  return output;\r\n}\r\n\r\nexport function fromBase32(str: string) {\r\n  let bits = 0;\r\n  let value = 0;\r\n  const output: number[] = [];\r\n  const clean = str.replace(/=+$/,'').toUpperCase();\r\n  for (let i = 0; i < clean.length; i++) {\r\n    const idx = alphabet.indexOf(clean[i]);\r\n    if (idx === -1) continue;\r\n    value = (value << 5) | idx;\r\n    bits += 5;\r\n    if (bits >= 8) {\r\n      output.push((value >>> (bits - 8)) & 255);\r\n      bits -= 8;\r\n    }\r\n  }\r\n  return Buffer.from(output);\r\n}\r\n\r\nexport function totp(secretBase32: string, time = Date.now(), step = 30, digits = 6) {\r\n  const counter = Math.floor(time / 1000 / step);\r\n  const buffer = Buffer.alloc(8);\r\n  buffer.writeUInt32BE(Math.floor(counter / Math.pow(2, 32)), 0);\r\n  buffer.writeUInt32BE(counter & 0xffffffff, 4);\r\n  const key = fromBase32(secretBase32);\r\n  const hmac = crypto.createHmac('sha1', key).update(buffer).digest();\r\n  const offset = hmac[hmac.length - 1] & 0x0f;\r\n  const code = ((hmac[offset] & 0x7f) << 24) |\r\n               ((hmac[offset + 1] & 0xff) << 16) |\r\n               ((hmac[offset + 2] & 0xff) << 8) |\r\n               (hmac[offset + 3] & 0xff);\r\n  const otp = (code % Math.pow(10, digits)).toString().padStart(digits, '0');\r\n  return otp;\r\n}\r\n\r\nexport function verifyTotp(token: string, secretBase32: string, window = 1, step = 30, digits = 6) {\r\n  const now = Date.now();\r\n  for (let errorWindow = -window; errorWindow <= window; errorWindow++) {\r\n    const code = totp(secretBase32, now + errorWindow * step * 1000, step, digits);\r\n    if (code === token) return true;\r\n  }\r\n  return false;\r\n}\r\n\r\nexport function otpauthURL({ issuer, label, secret }: { issuer: string; label: string; secret: string; }) {\r\n  const params = new URLSearchParams({ secret, issuer, algorithm: 'SHA1', digits: '6', period: '30' });\r\n  return `otpauth://totp/${encodeURIComponent(`${issuer}:${label}`)}?${params.toString()}`;\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;AAEA,0DAA0D;AAC1D,MAAM,WAAW;AAEV,SAAS,aAAa,SAAS,EAAE;IACtC,MAAM,QAAQ,gHAAM,CAAC,WAAW,CAAC;IACjC,OAAO,SAAS;AAClB;AAEO,SAAS,SAAS,MAAc;IACrC,IAAI,OAAO;IACX,IAAI,QAAQ;IACZ,IAAI,SAAS;IACb,IAAK,IAAI,IAAI,GAAG,IAAI,OAAO,MAAM,EAAE,IAAK;QACtC,QAAQ,AAAC,SAAS,IAAK,MAAM,CAAC,EAAE;QAChC,QAAQ;QACR,MAAO,QAAQ,EAAG;YAChB,UAAU,QAAQ,CAAC,AAAC,UAAW,OAAO,IAAM,GAAG;YAC/C,QAAQ;QACV;IACF;IACA,IAAI,OAAO,GAAG;QACZ,UAAU,QAAQ,CAAC,AAAC,SAAU,IAAI,OAAS,GAAG;IAChD;IACA,OAAO;AACT;AAEO,SAAS,WAAW,GAAW;IACpC,IAAI,OAAO;IACX,IAAI,QAAQ;IACZ,MAAM,SAAmB,EAAE;IAC3B,MAAM,QAAQ,IAAI,OAAO,CAAC,OAAM,IAAI,WAAW;IAC/C,IAAK,IAAI,IAAI,GAAG,IAAI,MAAM,MAAM,EAAE,IAAK;QACrC,MAAM,MAAM,SAAS,OAAO,CAAC,KAAK,CAAC,EAAE;QACrC,IAAI,QAAQ,CAAC,GAAG;QAChB,QAAQ,AAAC,SAAS,IAAK;QACvB,QAAQ;QACR,IAAI,QAAQ,GAAG;YACb,OAAO,IAAI,CAAC,AAAC,UAAW,OAAO,IAAM;YACrC,QAAQ;QACV;IACF;IACA,OAAO,OAAO,IAAI,CAAC;AACrB;AAEO,SAAS,KAAK,YAAoB,EAAE,OAAO,KAAK,GAAG,EAAE,EAAE,OAAO,EAAE,EAAE,SAAS,CAAC;IACjF,MAAM,UAAU,KAAK,KAAK,CAAC,OAAO,OAAO;IACzC,MAAM,SAAS,OAAO,KAAK,CAAC;IAC5B,OAAO,aAAa,CAAC,KAAK,KAAK,CAAC,UAAU,KAAK,GAAG,CAAC,GAAG,MAAM;IAC5D,OAAO,aAAa,CAAC,UAAU,YAAY;IAC3C,MAAM,MAAM,WAAW;IACvB,MAAM,OAAO,gHAAM,CAAC,UAAU,CAAC,QAAQ,KAAK,MAAM,CAAC,QAAQ,MAAM;IACjE,MAAM,SAAS,IAAI,CAAC,KAAK,MAAM,GAAG,EAAE,GAAG;IACvC,MAAM,OAAO,AAAC,CAAC,IAAI,CAAC,OAAO,GAAG,IAAI,KAAK,KACzB,CAAC,IAAI,CAAC,SAAS,EAAE,GAAG,IAAI,KAAK,KAC7B,CAAC,IAAI,CAAC,SAAS,EAAE,GAAG,IAAI,KAAK,IAC7B,IAAI,CAAC,SAAS,EAAE,GAAG;IACjC,MAAM,MAAM,CAAC,OAAO,KAAK,GAAG,CAAC,IAAI,OAAO,EAAE,QAAQ,GAAG,QAAQ,CAAC,QAAQ;IACtE,OAAO;AACT;AAEO,SAAS,WAAW,KAAa,EAAE,YAAoB,EAAE,SAAS,CAAC,EAAE,OAAO,EAAE,EAAE,SAAS,CAAC;IAC/F,MAAM,MAAM,KAAK,GAAG;IACpB,IAAK,IAAI,cAAc,CAAC,QAAQ,eAAe,QAAQ,cAAe;QACpE,MAAM,OAAO,KAAK,cAAc,MAAM,cAAc,OAAO,MAAM,MAAM;QACvE,IAAI,SAAS,OAAO,OAAO;IAC7B;IACA,OAAO;AACT;AAEO,SAAS,WAAW,EAAE,MAAM,EAAE,KAAK,EAAE,MAAM,EAAsD;IACtG,MAAM,SAAS,IAAI,gBAAgB;QAAE;QAAQ;QAAQ,WAAW;QAAQ,QAAQ;QAAK,QAAQ;IAAK;IAClG,OAAO,CAAC,eAAe,EAAE,mBAAmB,GAAG,OAAO,CAAC,EAAE,OAAO,EAAE,CAAC,EAAE,OAAO,QAAQ,IAAI;AAC1F","debugId":null}},
    {"offset": {"line": 428, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/app/api/security/2fa/setup/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { verifyToken } from '@/lib/auth';\r\nimport { db, safeQuery } from '@/lib/db';\r\nimport { randomBase32, otpauthURL } from '@/lib/totp';\r\n\r\nasync function getUser(req: NextRequest) {\r\n  const token = req.cookies.get('token')?.value;\r\n  if (!token) return null;\r\n  const payload = await verifyToken(token);\r\n  if (!payload?.email) return null;\r\n  const user = await db.getUserByEmail(payload.email);\r\n  return user;\r\n}\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const user = await getUser(req);\r\n    if (!user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    await safeQuery('ALTER TABLE users ADD COLUMN IF NOT EXISTS twofa_enabled BOOLEAN DEFAULT false');\r\n    await safeQuery('ALTER TABLE users ADD COLUMN IF NOT EXISTS twofa_secret VARCHAR(255)');\r\n    const secret = randomBase32(20);\r\n    await safeQuery('UPDATE users SET twofa_secret = $1, twofa_enabled = false, updated_at = CURRENT_TIMESTAMP WHERE id = $2', [secret, user.id]);\r\n    const url = otpauthURL({ issuer: 'FinTrackrX', label: user.email, secret });\r\n    return NextResponse.json({ success: true, secret, otpauth: url });\r\n  } catch (e: any) {\r\n    return NextResponse.json({ success: false, error: e?.message || 'Failed to create 2FA secret' }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;;;;;AAEA,eAAe,QAAQ,GAAgB;IACrC,MAAM,QAAQ,IAAI,OAAO,CAAC,GAAG,CAAC,UAAU;IACxC,IAAI,CAAC,OAAO,OAAO;IACnB,MAAM,UAAU,MAAM,IAAA,4HAAW,EAAC;IAClC,IAAI,CAAC,SAAS,OAAO,OAAO;IAC5B,MAAM,OAAO,MAAM,iHAAE,CAAC,cAAc,CAAC,QAAQ,KAAK;IAClD,OAAO;AACT;AAEO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ;QAC3B,IAAI,CAAC,MAAM,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;QAC7E,MAAM,IAAA,wHAAS,EAAC;QAChB,MAAM,IAAA,wHAAS,EAAC;QAChB,MAAM,SAAS,IAAA,6HAAY,EAAC;QAC5B,MAAM,IAAA,wHAAS,EAAC,2GAA2G;YAAC;YAAQ,KAAK,EAAE;SAAC;QAC5I,MAAM,MAAM,IAAA,2HAAU,EAAC;YAAE,QAAQ;YAAc,OAAO,KAAK,KAAK;YAAE;QAAO;QACzE,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM;YAAQ,SAAS;QAAI;IACjE,EAAE,OAAO,GAAQ;QACf,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO,GAAG,WAAW;QAA8B,GAAG;YAAE,QAAQ;QAAI;IACjH;AACF","debugId":null}}]
}