{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/lib/auth.ts"],"sourcesContent":["// Auth utilities for password hashing and token generation\r\nimport bcrypt from 'bcryptjs';\r\nimport { SignJWT, jwtVerify } from 'jose';\r\n\r\nif (!process.env.JWT_SECRET) {\r\n  console.warn('‚ö†Ô∏è  WARNING: JWT_SECRET not set. Using default secret. This is unsafe for production!');\r\n}\r\n\r\nconst JWT_SECRET = new TextEncoder().encode(\r\n  process.env.JWT_SECRET || 'your-secret-key-change-in-production'\r\n);\r\n\r\n// Password hashing\r\nexport async function hashPassword(password: string): Promise<string> {\r\n  return bcrypt.hash(password, 10);\r\n}\r\n\r\nexport async function verifyPassword(password: string, hash: string): Promise<boolean> {\r\n  return bcrypt.compare(password, hash);\r\n}\r\n\r\n// Token generation\r\nexport function generateToken(): string {\r\n  return crypto.randomUUID() + crypto.randomUUID().replace(/-/g, '');\r\n}\r\n\r\n// JWT tokens\r\nexport async function createToken(payload: { userId: string; email: string }): Promise<string> {\r\n  return new SignJWT(payload)\r\n    .setProtectedHeader({ alg: 'HS256' })\r\n    .setIssuedAt()\r\n    .setExpirationTime('7d')\r\n    .sign(JWT_SECRET);\r\n}\r\n\r\nexport async function verifyToken(token: string): Promise<{ userId: string; email: string } | null> {\r\n  try {\r\n    const { payload } = await jwtVerify(token, JWT_SECRET);\r\n    return payload as { userId: string; email: string };\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n\r\n// MFA token (short‚Äëlived, used only to complete 2FA)\r\nexport async function createMfaToken(payload: { userId: string; email: string }): Promise<string> {\r\n  return new SignJWT({ ...payload, mfa: true })\r\n    .setProtectedHeader({ alg: 'HS256' })\r\n    .setIssuedAt()\r\n    .setExpirationTime('5m')\r\n    .sign(JWT_SECRET);\r\n}\r\n\r\nexport async function verifyMfaToken(token: string): Promise<{ userId: string; email: string; mfa: true } | null> {\r\n  try {\r\n    const { payload } = await jwtVerify(token, JWT_SECRET);\r\n    if (payload && (payload as any).mfa === true) {\r\n      return payload as { userId: string; email: string; mfa: true };\r\n    }\r\n    return null;\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n\r\nexport const auth = {\r\n  hashPassword,\r\n  verifyPassword,\r\n  generateToken,\r\n  createToken,\r\n  verifyToken,\r\n  createMfaToken,\r\n  verifyMfaToken,\r\n};\r\n\r\n// Validation schemas\r\nexport const validation = {\r\n  email: (email: string) => /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email),\r\n  \r\n  password: (password: string) => {\r\n    // At least 8 characters, 1 uppercase, 1 lowercase, 1 number\r\n    return password.length >= 8 &&\r\n           /[A-Z]/.test(password) &&\r\n           /[a-z]/.test(password) &&\r\n           /[0-9]/.test(password);\r\n  },\r\n\r\n  passwordMessage: 'Password must be at least 8 characters with 1 uppercase, 1 lowercase, and 1 number',\r\n};\r\n"],"names":[],"mappings":"AAAA,2DAA2D;;;;;;;;;;;;;;;;;;;;;AAC3D;AACA;AAAA;;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,UAAU,EAAE;IAC3B,QAAQ,IAAI,CAAC;AACf;AAEA,MAAM,aAAa,IAAI,cAAc,MAAM,CACzC,QAAQ,GAAG,CAAC,UAAU,IAAI;AAIrB,eAAe,aAAa,QAAgB;IACjD,OAAO,8IAAM,CAAC,IAAI,CAAC,UAAU;AAC/B;AAEO,eAAe,eAAe,QAAgB,EAAE,IAAY;IACjE,OAAO,8IAAM,CAAC,OAAO,CAAC,UAAU;AAClC;AAGO,SAAS;IACd,OAAO,OAAO,UAAU,KAAK,OAAO,UAAU,GAAG,OAAO,CAAC,MAAM;AACjE;AAGO,eAAe,YAAY,OAA0C;IAC1E,OAAO,IAAI,uKAAO,CAAC,SAChB,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,MAClB,IAAI,CAAC;AACV;AAEO,eAAe,YAAY,KAAa;IAC7C,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,2KAAS,EAAC,OAAO;QAC3C,OAAO;IACT,EAAE,OAAO,OAAO;QACd,OAAO;IACT;AACF;AAGO,eAAe,eAAe,OAA0C;IAC7E,OAAO,IAAI,uKAAO,CAAC;QAAE,GAAG,OAAO;QAAE,KAAK;IAAK,GACxC,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,WAAW,GACX,iBAAiB,CAAC,MAClB,IAAI,CAAC;AACV;AAEO,eAAe,eAAe,KAAa;IAChD,IAAI;QACF,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,2KAAS,EAAC,OAAO;QAC3C,IAAI,WAAW,AAAC,QAAgB,GAAG,KAAK,MAAM;YAC5C,OAAO;QACT;QACA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,OAAO;IACT;AACF;AAEO,MAAM,OAAO;IAClB;IACA;IACA;IACA;IACA;IACA;IACA;AACF;AAGO,MAAM,aAAa;IACxB,OAAO,CAAC,QAAkB,6BAA6B,IAAI,CAAC;IAE5D,UAAU,CAAC;QACT,4DAA4D;QAC5D,OAAO,SAAS,MAAM,IAAI,KACnB,QAAQ,IAAI,CAAC,aACb,QAAQ,IAAI,CAAC,aACb,QAAQ,IAAI,CAAC;IACtB;IAEA,iBAAiB;AACnB","debugId":null}},
    {"offset": {"line": 174, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/lib/db.ts"],"sourcesContent":["// Database connection pool for PostgreSQL\r\nimport { Pool, PoolClient, QueryResult } from 'pg';\r\n\r\n// Support discrete DB_* env vars or a full DATABASE_URL\r\nfunction buildConnectionString(): string | undefined {\r\n  if (process.env.DATABASE_URL) return process.env.DATABASE_URL;\r\n  const host = process.env.DB_HOST;\r\n  const user = process.env.DB_USER;\r\n  const pass = process.env.DB_PASSWORD;\r\n  const name = process.env.DB_NAME;\r\n  const port = process.env.DB_PORT || '5432';\r\n  if (host && user && pass && name) {\r\n    return `postgresql://${user}:${encodeURIComponent(pass)}@${host}:${port}/${name}`;\r\n  }\r\n  return undefined;\r\n}\r\n\r\nconst connectionString = buildConnectionString();\r\nif (!connectionString) {\r\n  console.warn('‚ö†Ô∏è  WARNING: No database connection details provided. Set DATABASE_URL or DB_HOST/DB_USER/DB_PASSWORD/DB_NAME.');\r\n}\r\n\r\n// Enable SSL automatically for Supabase or when DATABASE_SSL=true\r\nconst useSsl = (process.env.DATABASE_SSL || '').toLowerCase() === 'true' || (connectionString?.includes('supabase.com') || connectionString?.includes('supabase.co'));\r\n\r\nconst pool = new Pool({\r\n  connectionString: connectionString,\r\n  max: 20,\r\n  // Increase timeouts to be more tolerant of transient network/DB latency\r\n  idleTimeoutMillis: 60000,\r\n  connectionTimeoutMillis: 10000,\r\n  keepAlive: true,\r\n  ssl: useSsl ? { rejectUnauthorized: false } : undefined,\r\n});\r\n\r\n// Test connection\r\npool.on('connect', () => {\r\n  console.log('‚úÖ Database connected');\r\n});\r\n\r\npool.on('error', (err) => {\r\n  console.error('‚ùå Unexpected database error:', err);\r\n  // Don't exit process in production, just log the error\r\n  if (process.env.NODE_ENV !== 'production') {\r\n    process.exit(-1);\r\n  }\r\n});\r\n\r\nexport default pool;\r\n\r\n// Export query function\r\nexport const query = pool.query.bind(pool);\r\n\r\n// Safe query with retry for transient connection issues\r\nexport async function safeQuery(text: string, params?: any[]): Promise<QueryResult<any>> {\r\n  const maxAttempts = 3;\r\n  for (let attempt = 1; attempt <= maxAttempts; attempt++) {\r\n    try {\r\n      return await pool.query(text, params);\r\n    } catch (err: any) {\r\n      const msg = err?.message || '';\r\n      const isTransient = msg.includes('Connection terminated') || msg.includes('connection timeout') || msg.includes('Connection terminated unexpectedly') || msg.includes('ECONNRESET') || err?.code === '57P01' || err?.code === 'ECONNRESET' || err?.code === '57P03';\r\n      if (attempt < maxAttempts && isTransient) {\r\n        console.warn(`‚ö†Ô∏è Transient DB error (attempt ${attempt}): ${msg}. Retrying in ${attempt * 300}ms...`);\r\n        await new Promise((resolve) => setTimeout(resolve, attempt * 300));\r\n        continue;\r\n      }\r\n      throw err;\r\n    }\r\n  }\r\n  throw new Error('safeQuery: exhausted retries without success');\r\n}\r\n\r\n// Helper function for transactions\r\nexport async function withTransaction<T>(\r\n  callback: (client: PoolClient) => Promise<T>\r\n): Promise<T> {\r\n  const client = await pool.connect();\r\n  try {\r\n    await client.query('BEGIN');\r\n    const result = await callback(client);\r\n    await client.query('COMMIT');\r\n    return result;\r\n  } catch (error) {\r\n    await client.query('ROLLBACK');\r\n    throw error;\r\n  } finally {\r\n    client.release();\r\n  }\r\n}\r\n\r\n// Common database queries\r\nexport const db = {\r\n  // Users\r\n  async getUserByEmail(email: string) {\r\n    const result = await pool.query(\r\n      'SELECT * FROM users WHERE email = $1',\r\n      [email]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async getUserById(id: string) {\r\n    const result = await pool.query(\r\n      'SELECT id, email, name, created_at FROM users WHERE id = $1',\r\n      [id]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async createUser(email: string, name: string, passwordHash: string) {\r\n    const result = await pool.query(\r\n      'INSERT INTO users (email, name, password_hash) VALUES ($1, $2, $3) RETURNING id, email, name, created_at',\r\n      [email, name, passwordHash]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async updateUserPassword(userId: string, passwordHash: string) {\r\n    await pool.query(\r\n      'UPDATE users SET password_hash = $1, updated_at = CURRENT_TIMESTAMP WHERE id = $2',\r\n      [passwordHash, userId]\r\n    );\r\n  },\r\n\r\n  async updateLastLogin(userId: string) {\r\n    await pool.query(\r\n      'UPDATE users SET last_login = CURRENT_TIMESTAMP WHERE id = $1',\r\n      [userId]\r\n    );\r\n  },\r\n\r\n  // Verification tokens\r\n  async createVerificationToken(userId: string, token: string, expiresAt: Date) {\r\n    await pool.query(\r\n      'INSERT INTO verification_tokens (user_id, token, expires_at) VALUES ($1, $2, $3)',\r\n      [userId, token, expiresAt]\r\n    );\r\n  },\r\n\r\n  async getVerificationToken(token: string) {\r\n    const result = await pool.query(\r\n      'SELECT * FROM verification_tokens WHERE token = $1 AND expires_at > NOW()',\r\n      [token]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n\r\n  async deleteVerificationToken(token: string) {\r\n    await pool.query('DELETE FROM verification_tokens WHERE token = $1', [token]);\r\n  },\r\n\r\n  // Transactions\r\n  async getTransactions(userId: string, limit = 50, offset = 0) {\r\n    const result = await pool.query(\r\n      `SELECT t.*, c.name as category_name, a.name as account_name \r\n       FROM transactions t\r\n       LEFT JOIN categories c ON t.category_id = c.id\r\n       LEFT JOIN accounts a ON t.account_id = a.id\r\n       WHERE t.user_id = $1\r\n       ORDER BY t.date DESC, t.created_at DESC\r\n       LIMIT $2 OFFSET $3`,\r\n      [userId, limit, offset]\r\n    );\r\n    return result.rows;\r\n  },\r\n\r\n  async createTransaction(userId: string, data: {\r\n    accountId?: string;\r\n    categoryId?: string;\r\n    type: string;\r\n    amount: number;\r\n    description?: string;\r\n    date: Date;\r\n    notes?: string;\r\n  }) {\r\n    const result = await pool.query(\r\n      `INSERT INTO transactions (user_id, account_id, category_id, type, amount, description, date, notes)\r\n       VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\r\n       RETURNING *`,\r\n      [userId, data.accountId, data.categoryId, data.type, data.amount, data.description, data.date, data.notes]\r\n    );\r\n    return result.rows[0];\r\n  },\r\n};\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 356, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/lib/finnhub.ts"],"sourcesContent":["// Finnhub API integration for stock market data\r\nconst FINNHUB_API_KEY = process.env.FINNHUB_API_KEY || 'd487ge1r01qk80bjptfgd487ge1r01qk80bjptg0';\r\nconst FINNHUB_BASE_URL = 'https://finnhub.io/api/v1';\r\n\r\n// Get stock quote (current price, change, etc.)\r\nexport async function getQuote(symbol: string) {\r\n  try {\r\n    const response = await fetch(\r\n      `${FINNHUB_BASE_URL}/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`\r\n    );\r\n    const data = await response.json();\r\n    \r\n    return {\r\n      currentPrice: data.c, // Current price\r\n      change: data.d, // Change\r\n      percentChange: data.dp, // Percent change\r\n      high: data.h, // High price of the day\r\n      low: data.l, // Low price of the day\r\n      open: data.o, // Open price of the day\r\n      previousClose: data.pc, // Previous close price\r\n      timestamp: data.t, // Timestamp\r\n    };\r\n  } catch (error) {\r\n    console.error('Finnhub quote error:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n// Get company profile\r\nexport async function getCompanyProfile(symbol: string) {\r\n  try {\r\n    const response = await fetch(\r\n      `${FINNHUB_BASE_URL}/stock/profile2?symbol=${symbol}&token=${FINNHUB_API_KEY}`\r\n    );\r\n    const data = await response.json();\r\n    \r\n    return {\r\n      name: data.name,\r\n      ticker: data.ticker,\r\n      exchange: data.exchange,\r\n      currency: data.currency,\r\n      country: data.country,\r\n      industry: data.finnhubIndustry,\r\n      logo: data.logo,\r\n      marketCap: data.marketCapitalization,\r\n    };\r\n  } catch (error) {\r\n    console.error('Finnhub profile error:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n// Search for stocks\r\nexport async function searchSymbol(query: string) {\r\n  try {\r\n    const url = `${FINNHUB_BASE_URL}/search?q=${query}&token=${FINNHUB_API_KEY}`;\r\n    console.log('üåê Fetching from Finnhub:', url);\r\n    \r\n    const response = await fetch(url);\r\n    const data = await response.json();\r\n    \r\n    console.log('üì° Raw Finnhub API response:', data);\r\n    \r\n    // Check if data.result exists and is an array\r\n    if (!data.result || !Array.isArray(data.result)) {\r\n      console.warn('‚ö†Ô∏è Unexpected Finnhub response structure:', data);\r\n      return [];\r\n    }\r\n    \r\n    const mapped = data.result.map((item: any) => ({\r\n      symbol: item.symbol,\r\n      description: item.description,\r\n      type: item.type,\r\n      displaySymbol: item.displaySymbol,\r\n    }));\r\n    \r\n    console.log('üîß Mapped results:', mapped);\r\n    return mapped;\r\n  } catch (error) {\r\n    console.error('‚ùå Finnhub search error:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\n// Get historical candles (for charts)\r\nexport async function getCandles(symbol: string, resolution: string = 'D', from: number, to: number) {\r\n  try {\r\n    const response = await fetch(\r\n      `${FINNHUB_BASE_URL}/stock/candle?symbol=${symbol}&resolution=${resolution}&from=${from}&to=${to}&token=${FINNHUB_API_KEY}`\r\n    );\r\n    const data = await response.json();\r\n    \r\n    if (data.s !== 'ok') return null;\r\n    \r\n    return {\r\n      timestamps: data.t,\r\n      open: data.o,\r\n      high: data.h,\r\n      low: data.l,\r\n      close: data.c,\r\n      volume: data.v,\r\n    };\r\n  } catch (error) {\r\n    console.error('Finnhub candles error:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n// Get market news\r\nexport async function getMarketNews(category: string = 'general') {\r\n  try {\r\n    const response = await fetch(\r\n      `${FINNHUB_BASE_URL}/news?category=${category}&token=${FINNHUB_API_KEY}`\r\n    );\r\n    const data = await response.json();\r\n    \r\n    return data.slice(0, 10).map((item: any) => ({\r\n      headline: item.headline,\r\n      summary: item.summary,\r\n      source: item.source,\r\n      url: item.url,\r\n      image: item.image,\r\n      datetime: item.datetime,\r\n    }));\r\n  } catch (error) {\r\n    console.error('Finnhub news error:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\n// Get company news\r\nexport async function getCompanyNews(symbol: string, from: string, to: string) {\r\n  try {\r\n    const response = await fetch(\r\n      `${FINNHUB_BASE_URL}/company-news?symbol=${symbol}&from=${from}&to=${to}&token=${FINNHUB_API_KEY}`\r\n    );\r\n    const data = await response.json();\r\n    \r\n    return data.slice(0, 10).map((item: any) => ({\r\n      headline: item.headline,\r\n      summary: item.summary,\r\n      source: item.source,\r\n      url: item.url,\r\n      image: item.image,\r\n      datetime: item.datetime,\r\n    }));\r\n  } catch (error) {\r\n    console.error('Finnhub company news error:', error);\r\n    return [];\r\n  }\r\n}\r\n\r\n// Batch update prices for multiple symbols\r\nexport async function batchUpdatePrices(symbols: string[]): Promise<{ [symbol: string]: number }> {\r\n  const quotes = await Promise.all(\r\n    symbols.map(async (symbol) => {\r\n      const quote = await getQuote(symbol);\r\n      return { symbol, price: quote?.currentPrice || 0 };\r\n    })\r\n  );\r\n  \r\n  const priceMap: { [symbol: string]: number } = {};\r\n  quotes.forEach(({ symbol, price }) => {\r\n    priceMap[symbol] = price;\r\n  });\r\n  \r\n  return priceMap;\r\n}\r\n\r\nexport const finnhubService = {\r\n  getQuote,\r\n  getCompanyProfile,\r\n  searchSymbol,\r\n  getCandles,\r\n  getMarketNews,\r\n  getCompanyNews,\r\n  batchUpdatePrices,\r\n};\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 521, "column": 0}, "map": {"version":3,"sources":["file:///D:/FullStackDev/fintrackrx/app/api/investments/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { verifyToken } from '@/lib/auth';\r\nimport { query, safeQuery } from '@/lib/db';\r\nimport { getQuote, getCompanyProfile } from '@/lib/finnhub';\r\n\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    const token = request.cookies.get('token')?.value;\r\n    \r\n    if (!token) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    const payload = await verifyToken(token);\r\n    if (!payload) {\r\n      return NextResponse.json({ error: 'Invalid token' }, { status: 401 });\r\n    }\r\n    const userId = payload.userId;\r\n\r\n    const result = await safeQuery(\r\n      `SELECT \r\n        id, symbol, name, quantity, purchase_price, purchase_date, \r\n        current_price, currency, exchange, notes, created_at, updated_at\r\n       FROM investments \r\n       WHERE user_id = $1 \r\n       ORDER BY created_at DESC`,\r\n      [userId]\r\n    );\r\n\r\n    // Calculate portfolio totals\r\n    let totalValue = 0;\r\n    let totalCost = 0;\r\n    const investments = result.rows.map(inv => {\r\n      const currentValue = inv.quantity * (inv.current_price || inv.purchase_price);\r\n      const costValue = inv.quantity * inv.purchase_price;\r\n      totalValue += currentValue;\r\n      totalCost += costValue;\r\n\r\n      return {\r\n        ...inv,\r\n        currentValue,\r\n        costValue,\r\n        gain: currentValue - costValue,\r\n        gainPercent: ((currentValue - costValue) / costValue) * 100\r\n      };\r\n    });\r\n\r\n    return NextResponse.json({\r\n      investments,\r\n      portfolio: {\r\n        totalValue,\r\n        totalCost,\r\n        totalGain: totalValue - totalCost,\r\n        totalGainPercent: totalCost > 0 ? ((totalValue - totalCost) / totalCost) * 100 : 0\r\n      }\r\n    });\r\n  } catch (error) {\r\n    console.error('Get investments error:', error);\r\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });\r\n  }\r\n}\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const token = request.cookies.get('token')?.value;\r\n    \r\n    if (!token) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\r\n    }\r\n\r\n    const payload = await verifyToken(token);\r\n    if (!payload) {\r\n      return NextResponse.json({ error: 'Invalid token' }, { status: 401 });\r\n    }\r\n    const userId = payload.userId;\r\n\r\n    const { symbol, quantity, purchasePrice, purchaseDate, notes } = await request.json();\r\n\r\n    if (!symbol || !quantity || !purchasePrice) {\r\n      return NextResponse.json({ error: 'Symbol, quantity, and purchase price are required' }, { status: 400 });\r\n    }\r\n\r\n    // Fetch company info and current price from Finnhub\r\n    let name = symbol;\r\n    let currentPrice = purchasePrice;\r\n    let currency = 'INR';\r\n    let exchange = '';\r\n\r\n    try {\r\n      const [profile, quote] = await Promise.all([\r\n        getCompanyProfile(symbol),\r\n        getQuote(symbol)\r\n      ]);\r\n\r\n      if (profile) {\r\n        name = profile.name || symbol;\r\n        currency = profile.currency || 'INR';\r\n        exchange = profile.exchange || '';\r\n      }\r\n\r\n      if (quote && quote.currentPrice) {\r\n        currentPrice = quote.currentPrice;\r\n      }\r\n    } catch (err) {\r\n      console.error('Failed to fetch stock data:', err);\r\n      // Continue with provided data\r\n    }\r\n\r\n    const result = await safeQuery(\r\n      `INSERT INTO investments \r\n        (user_id, symbol, name, quantity, purchase_price, purchase_date, current_price, currency, exchange, notes)\r\n       VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)\r\n       RETURNING *`,\r\n      [\r\n        userId,\r\n        symbol.toUpperCase(),\r\n        name,\r\n        quantity,\r\n        purchasePrice,\r\n        purchaseDate || new Date(),\r\n        currentPrice,\r\n        currency,\r\n        exchange,\r\n        notes || null\r\n      ]\r\n    );\r\n\r\n    return NextResponse.json({ investment: result.rows[0] }, { status: 201 });\r\n  } catch (error) {\r\n    console.error('Create investment error:', error);\r\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}